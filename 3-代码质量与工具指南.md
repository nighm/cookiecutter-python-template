# 代码质量与工具指南

## 一、代码质量工具总览

### 1.1 基础代码检查工具
| 工具名称 | 用途 | 命令 |
|---------|------|------|
| Black | 代码格式化 | `poetry run black .` |
| isort | 导入排序 | `poetry run isort .` |
| Flake8 | 代码规范检查 | `poetry run flake8` |
| MyPy | 类型检查 | `poetry run mypy src` |

### 1.2 高级检查工具
| 工具名称 | 用途 | 命令 |
|---------|------|------|
| Bandit | 安全检查 | `poetry run bandit -r ./src` |
| Safety | 依赖安全检查 | `poetry run safety check` |
| Pylint | 代码分析 | `poetry run pylint ./src` |
| Radon | 复杂度分析 | `poetry run radon cc ./src` |

## 二、自动化检查配置

### 2.1 Pre-commit配置
```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.0.0
    hooks:
      - id: black
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.0
    hooks:
      - id: bandit
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.0.0
    hooks:
      - id: mypy
```

### 2.2 GitHub Actions配置
```yaml
# .github/workflows/ci.yml
jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Run checks
        run: |
          poetry run black . --check
          poetry run bandit -r ./src
          poetry run safety check
```

## 三、代码检查详解

### 3.1 代码风格检查
1. **Black格式化**
   ```python
   # 格式化前
   def hello(    name     ):
       return     'Hello, '+name
   
   # 格式化后
   def hello(name):
       return "Hello, " + name
   ```

2. **isort导入排序**
   ```python
   # 排序前
   import os
   from typing import List
   import sys
   from my_module import my_function
   
   # 排序后
   import os
   import sys
   from typing import List
   
   from my_module import my_function
   ```

### 3.2 类型检查
```python
# MyPy类型检查示例
def greet(name: str) -> str:
    return f"Hello, {name}"

def bad_greet(name: str) -> str:
    return 42  # MyPy错误：返回类型不匹配
```

### 3.3 安全检查
```python
# Bandit安全检查示例
# 不安全的代码
import pickle
data = pickle.loads(user_input)  # Bandit警告：不安全的反序列化

# 安全的代码
import json
data = json.loads(user_input)
```

## 四、性能分析工具

### 4.1 代码性能分析
```bash
# 使用Scalene进行性能分析
poetry run scalene your_script.py

# 使用py-spy生成性能报告
py-spy record -o profile.svg -- python your_script.py
```

### 4.2 复杂度分析
```bash
# 使用Radon分析代码复杂度
poetry run radon cc ./src

# 使用Xenon设置复杂度门禁
poetry run xenon --max-absolute A ./src
```

## 五、文档质量工具

### 5.1 文档检查
```bash
# 使用Pydocstyle检查文档风格
poetry run pydocstyle ./src

# 使用interrogate检查文档覆盖率
poetry run interrogate -v ./src
```

### 5.2 文档示例
```python
def calculate_total(items: list[float]) -> float:
    """计算列表中所有数字的总和。

    Args:
        items: 包含数字的列表

    Returns:
        所有数字的总和

    Examples:
        >>> calculate_total([1.0, 2.0, 3.0])
        6.0
    """
    return sum(items)
```

## 六、测试覆盖率工具

### 6.1 测试覆盖率检查
```bash
# 运行测试并生成覆盖率报告
poetry run pytest --cov=src --cov-report=html

# 查看具体的覆盖率信息
poetry run coverage report
```

### 6.2 覆盖率报告示例
```
Name                    Stmts   Miss  Cover
-------------------------------------------
src/__init__.py            0      0   100%
src/core/main.py         45      5    89%
src/utils/helpers.py     30      3    90%
-------------------------------------------
TOTAL                    75      8    89%
```

## 七、工具使用最佳实践

### 7.1 本地开发流程
1. 编写代码时使用IDE集成的检查工具
2. 提交前运行完整的检查套件
3. 定期进行性能分析

### 7.2 CI/CD集成
1. 在PR时运行所有检查
2. 设置适当的检查级别
3. 自动化测试覆盖率报告

### 7.3 团队协作
1. 统一代码风格标准
2. 共享检查配置文件
3. 定期代码审查 